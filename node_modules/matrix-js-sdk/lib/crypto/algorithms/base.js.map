{"version":3,"sources":["../../../src/crypto/algorithms/base.js"],"names":["utils","require","module","exports","ENCRYPTION_CLASSES","DECRYPTION_CLASSES","EncryptionAlgorithm","params","_userId","userId","_deviceId","deviceId","_crypto","crypto","_olmDevice","olmDevice","_baseApis","baseApis","_roomId","roomId","prototype","onRoomMembership","event","member","oldMembership","DecryptionAlgorithm","onRoomKeyEvent","importRoomKey","session","DecryptionError","msg","details","name","message","inherits","Error","toString","result","Object","keys","map","k","join","UnknownDeviceError","devices","registerAlgorithm","algorithm","encryptor","decryptor"],"mappings":"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","file":"base.js","sourcesContent":["/*\nCopyright 2016 OpenMarket Ltd\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\"use strict\";\n\n/**\n * Internal module. Defines the base classes of the encryption implementations\n *\n * @module crypto/algorithms/base\n */\nconst utils = require(\"../../utils\");\n\n/**\n * map of registered encryption algorithm classes. A map from string to {@link\n * module:crypto/algorithms/base.EncryptionAlgorithm|EncryptionAlgorithm} class\n *\n * @type {Object.<string, function(new: module:crypto/algorithms/base.EncryptionAlgorithm)>}\n */\nmodule.exports.ENCRYPTION_CLASSES = {};\n\n/**\n * map of registered encryption algorithm classes. Map from string to {@link\n * module:crypto/algorithms/base.DecryptionAlgorithm|DecryptionAlgorithm} class\n *\n * @type {Object.<string, function(new: module:crypto/algorithms/base.DecryptionAlgorithm)>}\n */\nmodule.exports.DECRYPTION_CLASSES = {};\n\n/**\n * base type for encryption implementations\n *\n * @constructor\n * @alias module:crypto/algorithms/base.EncryptionAlgorithm\n *\n * @param {object} params parameters\n * @param {string} params.userId  The UserID for the local user\n * @param {string} params.deviceId The identifier for this device.\n * @param {module:crypto} params.crypto crypto core\n * @param {module:crypto/OlmDevice} params.olmDevice olm.js wrapper\n * @param {module:base-apis~MatrixBaseApis} baseApis base matrix api interface\n * @param {string} params.roomId  The ID of the room we will be sending to\n * @param {object} params.config  The body of the m.room.encryption event\n */\nconst EncryptionAlgorithm = function(params) {\n    this._userId = params.userId;\n    this._deviceId = params.deviceId;\n    this._crypto = params.crypto;\n    this._olmDevice = params.olmDevice;\n    this._baseApis = params.baseApis;\n    this._roomId = params.roomId;\n};\n/** */\nmodule.exports.EncryptionAlgorithm = EncryptionAlgorithm;\n\n/**\n * Encrypt a message event\n *\n * @method module:crypto/algorithms/base.EncryptionAlgorithm#encryptMessage\n * @abstract\n *\n * @param {module:models/room} room\n * @param {string} eventType\n * @param {object} plaintext event content\n *\n * @return {module:client.Promise} Promise which resolves to the new event body\n */\n\n/**\n * Called when the membership of a member of the room changes.\n *\n * @param {module:models/event.MatrixEvent} event  event causing the change\n * @param {module:models/room-member} member  user whose membership changed\n * @param {string=} oldMembership  previous membership\n */\nEncryptionAlgorithm.prototype.onRoomMembership = function(\n    event, member, oldMembership,\n) {};\n\n/**\n * base type for decryption implementations\n *\n * @constructor\n * @alias module:crypto/algorithms/base.DecryptionAlgorithm\n *\n * @param {object} params parameters\n * @param {string} params.userId  The UserID for the local user\n * @param {module:crypto} params.crypto crypto core\n * @param {module:crypto/OlmDevice} params.olmDevice olm.js wrapper\n * @param {string=} params.roomId The ID of the room we will be receiving\n *     from. Null for to-device events.\n */\nconst DecryptionAlgorithm = function(params) {\n    this._userId = params.userId;\n    this._crypto = params.crypto;\n    this._olmDevice = params.olmDevice;\n    this._roomId = params.roomId;\n};\n/** */\nmodule.exports.DecryptionAlgorithm = DecryptionAlgorithm;\n\n/**\n * Decrypt an event\n *\n * @method module:crypto/algorithms/base.DecryptionAlgorithm#decryptEvent\n * @abstract\n *\n * @param {object} event raw event\n *\n * @return {null} if the event referred to an unknown megolm session\n * @return {module:crypto.DecryptionResult} decryption result\n *\n * @throws {module:crypto/algorithms/base.DecryptionError} if there is a\n *   problem decrypting the event\n */\n\n/**\n * Handle a key event\n *\n * @method module:crypto/algorithms/base.DecryptionAlgorithm#onRoomKeyEvent\n *\n * @param {module:models/event.MatrixEvent} params event key event\n */\nDecryptionAlgorithm.prototype.onRoomKeyEvent = function(params) {\n    // ignore by default\n};\n\n/**\n * Import a room key\n *\n * @param {module:crypto/OlmDevice.MegolmSessionData} session\n */\nDecryptionAlgorithm.prototype.importRoomKey = function(session) {\n    // ignore by default\n};\n\n/**\n * Exception thrown when decryption fails\n *\n * @alias module:crypto/algorithms/base.DecryptionError\n * @constructor\n * @param {string} msg user-visible message describing the problem\n *\n * @param {Object=} details key/value pairs reported in the logs but not shown\n *   to the user.\n *\n * @extends Error\n */\nconst DecryptionError = function(msg, details) {\n    this.name = 'DecryptionError';\n    this.message = msg;\n    this.details = details;\n};\nutils.inherits(DecryptionError, Error);\n\n/** override the string used when logging\n *\n * @returns {String}\n */\nDecryptionError.prototype.toString = function() {\n    let result = this.name + '[msg: ' + this.message;\n\n    if (this.details) {\n        result += ', ' +\n            Object.keys(this.details).map(\n                (k) => k + ': ' + this.details[k],\n            ).join(', ');\n    }\n\n    result += ']';\n\n    return result;\n};\n\nmodule.exports.DecryptionError = DecryptionError;\n\n/**\n * Exception thrown specifically when we want to warn the user to consider\n * the security of their conversation before continuing\n *\n * @constructor\n * @param {string} msg message describing the problem\n * @param {Object} devices userId -> {deviceId -> object}\n *      set of unknown devices per user we're warning about\n * @extends Error\n */\nmodule.exports.UnknownDeviceError = function(msg, devices) {\n    this.name = \"UnknownDeviceError\";\n    this.message = msg;\n    this.devices = devices;\n};\nutils.inherits(module.exports.UnknownDeviceError, Error);\n\n/**\n * Registers an encryption/decryption class for a particular algorithm\n *\n * @param {string} algorithm algorithm tag to register for\n *\n * @param {class} encryptor {@link\n *     module:crypto/algorithms/base.EncryptionAlgorithm|EncryptionAlgorithm}\n *     implementation\n *\n * @param {class} decryptor {@link\n *     module:crypto/algorithms/base.DecryptionAlgorithm|DecryptionAlgorithm}\n *     implementation\n */\nmodule.exports.registerAlgorithm = function(algorithm, encryptor, decryptor) {\n    module.exports.ENCRYPTION_CLASSES[algorithm] = encryptor;\n    module.exports.DECRYPTION_CLASSES[algorithm] = decryptor;\n};\n"]}