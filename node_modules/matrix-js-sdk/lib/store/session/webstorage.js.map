{"version":3,"sources":["../../../src/store/session/webstorage.js"],"names":["utils","require","DEBUG","E2E_PREFIX","WebStorageSessionStore","webStore","store","isFunction","getItem","setItem","removeItem","key","length","Error","prototype","removeEndToEndAccount","KEY_END_TO_END_ACCOUNT","getEndToEndAccount","getAllEndToEndDevices","prefix","keyEndToEndDevicesForUser","devices","i","userId","substr","startsWith","getJsonItem","getEndToEndDeviceTrackingStatus","KEY_END_TO_END_DEVICE_LIST_TRACKING_STATUS","getEndToEndDeviceSyncToken","KEY_END_TO_END_DEVICE_SYNC_TOKEN","removeEndToEndDeviceData","removeByPrefix","getEndToEndSessions","deviceKey","keyEndToEndSessions","getAllEndToEndSessions","deviceKeys","getKeysWithPrefix","results","k","unprefixedKey","removeAllEndToEndSessions","getAllEndToEndInboundGroupSessionKeys","result","push","senderKey","sessionId","getEndToEndInboundGroupSession","keyEndToEndInboundGroupSession","removeAllEndToEndInboundGroupSessions","getAllEndToEndRooms","roomKeys","keyEndToEndRoom","removeAllEndToEndRooms","roomId","JSON","parse","e","debuglog","stack","toRemove","log","arguments","module","exports"],"mappings":"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","file":"webstorage.js","sourcesContent":["/*\nCopyright 2015, 2016 OpenMarket Ltd\nCopyright 2017 New Vector Ltd\nCopyright 2018 New Vector Ltd\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\"use strict\";\n\n/**\n * @module store/session/webstorage\n */\n\nconst utils = require(\"../../utils\");\n\nconst DEBUG = false;  // set true to enable console logging.\nconst E2E_PREFIX = \"session.e2e.\";\n\n/**\n * Construct a web storage session store, capable of storing account keys,\n * session keys and access tokens.\n * @constructor\n * @param {WebStorage} webStore A web storage implementation, e.g.\n * 'window.localStorage' or 'window.sessionStorage' or a custom implementation.\n * @throws if the supplied 'store' does not meet the Storage interface of the\n * WebStorage API.\n */\nfunction WebStorageSessionStore(webStore) {\n    this.store = webStore;\n    if (!utils.isFunction(webStore.getItem) ||\n        !utils.isFunction(webStore.setItem) ||\n        !utils.isFunction(webStore.removeItem) ||\n        !utils.isFunction(webStore.key) ||\n        typeof(webStore.length) !== 'number'\n       ) {\n        throw new Error(\n            \"Supplied webStore does not meet the WebStorage API interface\",\n        );\n    }\n}\n\nWebStorageSessionStore.prototype = {\n    /**\n     * Remove the stored end to end account for the logged-in user.\n     */\n    removeEndToEndAccount: function() {\n        this.store.removeItem(KEY_END_TO_END_ACCOUNT);\n    },\n\n    /**\n     * Load the end to end account for the logged-in user.\n     * Note that the end-to-end account is now stored in the\n     * crypto store rather than here: this remains here so\n     * old sessions can be migrated out of the session store.\n     * @return {?string} Base64 encoded account.\n     */\n    getEndToEndAccount: function() {\n        return this.store.getItem(KEY_END_TO_END_ACCOUNT);\n    },\n\n    /**\n     * Retrieves the known devices for all users.\n     * @return {object} A map from user ID to map of device ID to keys for the device.\n     */\n    getAllEndToEndDevices: function() {\n        const prefix = keyEndToEndDevicesForUser('');\n        const devices = {};\n        for (let i = 0; i < this.store.length; ++i) {\n            const key = this.store.key(i);\n            const userId = key.substr(prefix.length);\n            if (key.startsWith(prefix)) devices[userId] = getJsonItem(this.store, key);\n        }\n        return devices;\n    },\n\n    getEndToEndDeviceTrackingStatus: function() {\n        return getJsonItem(this.store, KEY_END_TO_END_DEVICE_LIST_TRACKING_STATUS);\n    },\n\n    /**\n     * Get the sync token corresponding to the device list.\n     *\n     * @return {String?} token\n     */\n    getEndToEndDeviceSyncToken: function() {\n        return getJsonItem(this.store, KEY_END_TO_END_DEVICE_SYNC_TOKEN);\n    },\n\n    /**\n     * Removes all end to end device data from the store\n     */\n    removeEndToEndDeviceData: function() {\n        removeByPrefix(this.store, keyEndToEndDevicesForUser(''));\n        removeByPrefix(this.store, KEY_END_TO_END_DEVICE_LIST_TRACKING_STATUS);\n        removeByPrefix(this.store, KEY_END_TO_END_DEVICE_SYNC_TOKEN);\n    },\n\n    /**\n     * Retrieve the end-to-end sessions between the logged-in user and another\n     * device.\n     * @param {string} deviceKey The public key of the other device.\n     * @return {object} A map from sessionId to Base64 end-to-end session.\n     */\n    getEndToEndSessions: function(deviceKey) {\n        return getJsonItem(this.store, keyEndToEndSessions(deviceKey));\n    },\n\n    /**\n     * Retrieve all end-to-end sessions between the logged-in user and other\n     * devices.\n     * @return {object} A map of {deviceKey -> {sessionId -> session pickle}}\n     */\n    getAllEndToEndSessions: function() {\n        const deviceKeys = getKeysWithPrefix(this.store, keyEndToEndSessions(''));\n        const results = {};\n        for (const k of deviceKeys) {\n            const unprefixedKey = k.substr(keyEndToEndSessions('').length);\n            results[unprefixedKey] = getJsonItem(this.store, k);\n        }\n        return results;\n    },\n\n    /**\n     * Remove all end-to-end sessions from the store\n     * This is used after migrating sessions awat from the sessions store.\n     */\n    removeAllEndToEndSessions: function() {\n        removeByPrefix(this.store, keyEndToEndSessions(''));\n    },\n\n    /**\n     * Retrieve a list of all known inbound group sessions\n     *\n     * @return {{senderKey: string, sessionId: string}}\n     */\n    getAllEndToEndInboundGroupSessionKeys: function() {\n        const prefix = E2E_PREFIX + 'inboundgroupsessions/';\n        const result = [];\n        for (let i = 0; i < this.store.length; i++) {\n            const key = this.store.key(i);\n            if (!key.startsWith(prefix)) {\n                continue;\n            }\n            // we can't use split, as the components we are trying to split out\n            // might themselves contain '/' characters. We rely on the\n            // senderKey being a (32-byte) curve25519 key, base64-encoded\n            // (hence 43 characters long).\n\n            result.push({\n                senderKey: key.substr(prefix.length, 43),\n                sessionId: key.substr(prefix.length + 44),\n            });\n        }\n        return result;\n    },\n\n    getEndToEndInboundGroupSession: function(senderKey, sessionId) {\n        const key = keyEndToEndInboundGroupSession(senderKey, sessionId);\n        return this.store.getItem(key);\n    },\n\n    removeAllEndToEndInboundGroupSessions: function() {\n        removeByPrefix(this.store, E2E_PREFIX + 'inboundgroupsessions/');\n    },\n\n    /**\n     * Get the end-to-end state for all rooms\n     * @return {object} roomId -> object with the end-to-end info for the room.\n     */\n    getAllEndToEndRooms: function() {\n        const roomKeys = getKeysWithPrefix(this.store, keyEndToEndRoom(''));\n        const results = {};\n        for (const k of roomKeys) {\n            const unprefixedKey = k.substr(keyEndToEndRoom('').length);\n            results[unprefixedKey] = getJsonItem(this.store, k);\n        }\n        return results;\n    },\n\n    removeAllEndToEndRooms: function() {\n        removeByPrefix(this.store, keyEndToEndRoom(''));\n    },\n};\n\nconst KEY_END_TO_END_ACCOUNT = E2E_PREFIX + \"account\";\nconst KEY_END_TO_END_DEVICE_SYNC_TOKEN = E2E_PREFIX + \"device_sync_token\";\nconst KEY_END_TO_END_DEVICE_LIST_TRACKING_STATUS = E2E_PREFIX + \"device_tracking\";\n\nfunction keyEndToEndDevicesForUser(userId) {\n    return E2E_PREFIX + \"devices/\" + userId;\n}\n\nfunction keyEndToEndSessions(deviceKey) {\n    return E2E_PREFIX + \"sessions/\" + deviceKey;\n}\n\nfunction keyEndToEndInboundGroupSession(senderKey, sessionId) {\n    return E2E_PREFIX + \"inboundgroupsessions/\" + senderKey + \"/\" + sessionId;\n}\n\nfunction keyEndToEndRoom(roomId) {\n    return E2E_PREFIX + \"rooms/\" + roomId;\n}\n\nfunction getJsonItem(store, key) {\n    try {\n        // if the key is absent, store.getItem() returns null, and\n        // JSON.parse(null) === null, so this returns null.\n        return JSON.parse(store.getItem(key));\n    } catch (e) {\n        debuglog(\"Failed to get key %s: %s\", key, e);\n        debuglog(e.stack);\n    }\n    return null;\n}\n\nfunction getKeysWithPrefix(store, prefix) {\n    const results = [];\n    for (let i = 0; i < store.length; ++i) {\n        const key = store.key(i);\n        if (key.startsWith(prefix)) results.push(key);\n    }\n    return results;\n}\n\nfunction removeByPrefix(store, prefix) {\n    const toRemove = [];\n    for (let i = 0; i < store.length; ++i) {\n        const key = store.key(i);\n        if (key.startsWith(prefix)) toRemove.push(key);\n    }\n    for (const key of toRemove) {\n        store.removeItem(key);\n    }\n}\n\nfunction debuglog() {\n    if (DEBUG) {\n        console.log(...arguments);\n    }\n}\n\n/** */\nmodule.exports = WebStorageSessionStore;\n"]}